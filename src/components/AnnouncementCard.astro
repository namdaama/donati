---
import type { AnnouncementPost } from '../types/instagram';
import { generateSlug } from '../lib/announcement-parser';
import { getProxiedImageUrl } from '../config/instagram';

export interface Props {
  announcement: AnnouncementPost;
}

const { announcement } = Astro.props;

// æœ¬æ–‡ã‚’è¦ç´„ã—ã¦æœ€å¤§æ–‡å­—æ•°ã«åˆ¶é™
function truncateContent(content: string, maxLength: number = 50): string {
  if (content.length <= maxLength) {
    return content;
  }

  const truncated = content.substring(0, maxLength);
  const lastSpace = truncated.lastIndexOf('ã€‚');

  if (lastSpace > maxLength * 0.7) {
    return truncated.substring(0, lastSpace + 1);
  }

  return truncated + '...';
}

// æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
function formatDate(date: Date): string {
  if (!date || !(date instanceof Date)) return '';
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const dayOfWeek = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'][date.getDay()];
  return `${year}/${month} [${dayOfWeek}]`;
}
---

<a href={`/announcements/${generateSlug(announcement)}`} class="announcement-card-link">
  <div class="bg-white/20 backdrop-blur-sm rounded-2xl shadow-lg hover:shadow-xl transition-shadow duration-300 overflow-hidden border-2 border-overview-yellow/30">
    <!-- ã‚µãƒ ãƒã‚¤ãƒ« -->
    <div class="h-40 bg-overview-sky/20 flex items-center justify-center overflow-hidden">
      {announcement.imageUrl ? (
        <img
          src={getProxiedImageUrl(announcement.imageUrl, 400, 300)}
          alt={announcement.title}
          class="w-full h-full object-cover"
          loading="lazy"
        />
      ) : (
        <span class="text-4xl">ğŸ“…</span>
      )}
    </div>

    <!-- ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
    <div class="p-4">
      <div class="text-sm font-bold text-overview-yellow bg-overview-dark-blue px-3 py-1 rounded-full inline-block mb-3">
        {announcement.eventDate ? formatDate(announcement.eventDate) : formatDate(announcement.pubDate)}
      </div>
      <h3 class="font-bold text-overview-dark-blue mb-2 text-lg line-clamp-2">
        {announcement.title}
      </h3>
      {announcement.location && (
        <p class="text-sm text-gray-600 mb-2">
          {announcement.location}
        </p>
      )}
      <p class="text-xs text-overview-sky font-medium">
        {truncateContent(announcement.content)}
      </p>
    </div>
  </div>
</a>

<style>
  .announcement-card-link {
    text-decoration: none;
    color: inherit;
    display: block;
  }

  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
