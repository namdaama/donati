---
import Layout from '../../layouts/Layout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { fetchInstagramPosts } from '../../lib/instagram-graph-api';
import { filterAnnouncementPosts, generateSlug } from '../../lib/announcement-parser';
import { instagramConfig, getProxiedImageUrl } from '../../config/instagram';
import type { AnnouncementPost } from '../../types/instagram';

export async function getStaticPaths() {
  const posts = await fetchInstagramPosts();

  let announcements;
  if (instagramConfig.enableHashtagFilter) {
    announcements = filterAnnouncementPosts(posts, instagramConfig.announcementHashtag);
  } else {
    announcements = posts.map(post => ({
      ...post,
      category: 'news' as const,
      eventDate: undefined,
      location: undefined
    }));
  }

  return announcements.map((announcement) => ({
    params: { slug: generateSlug(announcement) },
    props: { announcement },
  }));
}

const { announcement } = Astro.props as { announcement: AnnouncementPost };

// æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
function formatDate(date: Date): string {
  if (!date || !(date instanceof Date)) return '';
  return date.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'short' });
}
---

<Layout title={`${announcement.title} - DONATI`}>
  <Header />

  <main class="flex-grow">
    <div class="container mx-auto px-4 py-16 md:py-24 max-w-4xl">
      <!-- æˆ»ã‚‹ãƒªãƒ³ã‚¯ -->
      <a href="/" class="inline-flex items-center text-overview-sky hover:text-overview-dark-blue transition-colors mb-8">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        ä¸€è¦§ã«æˆ»ã‚‹
      </a>

      <!-- ãƒ¡ã‚¤ãƒ³ç”»åƒ -->
      {announcement.imageUrl && (
        <div class="mb-8 rounded-2xl overflow-hidden shadow-xl">
          <img
            src={getProxiedImageUrl(announcement.imageUrl, 800, 600)}
            alt={announcement.title}
            class="w-full h-auto object-cover"
          />
        </div>
      )}

      <!-- ã‚«ãƒ†ã‚´ãƒªãƒãƒƒã‚¸ -->
      <div class="mb-4">
        <span class="inline-block px-4 py-2 bg-overview-sky text-white rounded-full text-sm font-bold">
          {announcement.category}
        </span>
      </div>

      <!-- ã‚¿ã‚¤ãƒˆãƒ« -->
      <h1 class="text-3xl md:text-4xl font-bold text-overview-dark-blue mb-6">
        {announcement.title}
      </h1>

      <!-- ãƒ¡ã‚¿æƒ…å ± -->
      <div class="bg-white/20 backdrop-blur-sm rounded-xl p-6 mb-8 border-2 border-overview-yellow/30">
        {announcement.eventDate && (
          <p class="text-overview-dark-blue mb-2">
            <span class="font-bold">ğŸ“… é–‹å‚¬æ—¥ï¼š</span>
            {formatDate(announcement.eventDate)}
          </p>
        )}
        {announcement.location && (
          <p class="text-overview-dark-blue mb-2">
            <span class="font-bold">ğŸ“ å ´æ‰€ï¼š</span>
            {announcement.location}
          </p>
        )}
        <p class="text-gray-600 text-sm">
          <span class="font-bold">æŠ•ç¨¿æ—¥ï¼š</span>
          {formatDate(announcement.pubDate)}
        </p>
      </div>

      <!-- æœ¬æ–‡ -->
      <div class="bg-white/15 backdrop-blur-sm rounded-2xl p-8 mb-8 shadow-lg">
        <div class="text-overview-dark-blue leading-relaxed whitespace-pre-wrap">
          {announcement.content}
        </div>
      </div>

      <!-- ãƒãƒƒã‚·ãƒ¥ã‚¿ã‚° -->
      {announcement.hashtags.length > 0 && (
        <div class="flex flex-wrap gap-2 mb-8">
          {announcement.hashtags.map((tag) => (
            <span class="px-3 py-1 bg-overview-sky/20 text-overview-sky rounded-full text-sm">
              {tag}
            </span>
          ))}
        </div>
      )}

      <!-- Instagramã§è¦‹ã‚‹ãƒªãƒ³ã‚¯ -->
      <div class="text-center">
        <a
          href={announcement.link}
          target="_blank"
          rel="noopener noreferrer"
          class="inline-flex items-center gap-2 bg-overview-dark-blue hover:bg-overview-dark-blue/90 text-white font-bold py-3 px-8 rounded-full transition-colors duration-300"
        >
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
          </svg>
          Instagramã§è¦‹ã‚‹
        </a>
      </div>
    </div>
  </main>

  <Footer />
</Layout>

<style>
  /* èƒŒæ™¯ç”»åƒã®é©ç”¨ */
  body {
    background-image: url('/images/backGround.png');
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    background-attachment: fixed;
  }

  /* èƒŒæ™¯ç”»åƒã®ä¸Šã«è»½ã„ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ã‚’è¿½åŠ  */
  body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(45deg, rgba(135, 206, 235, 0.1) 0%, rgba(255, 215, 0, 0.1) 100%);
    pointer-events: none;
    z-index: -1;
  }
</style>
