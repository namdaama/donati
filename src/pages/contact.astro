---
import Layout from '../layouts/Layout.astro';
import Header from '../components/common/Header.astro';
import Footer from '../components/common/Footer.astro';
import FooterDivider from '../components/overview/FooterDivider.astro';
import SectionHeading from '../components/common/SectionHeading.astro';

// Web3Forms Access Key
const WEB3FORMS_KEY = import.meta.env.PUBLIC_WEB3FORMS_ACCESS_KEY;
---

<Layout title="お問い合わせ">
  <Header />

  <main class="flex-grow">
    <style>
      body {
        background-image: url('/images/backGround.png');
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        background-attachment: fixed;
      }

      .form-wrapper {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }

      input, select, textarea {
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }

      input:focus, select:focus, textarea:focus {
        outline: none;
        border-color: #2c5aa0;
        box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
      }

      input.border-red-500:focus, select.border-red-500:focus, textarea.border-red-500:focus {
        border-color: #ef4444;
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
      }

      #message-modal {
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }

      #message-box {
        animation: slideUp 0.3s ease;
      }

      @keyframes slideUp {
        from {
          transform: translateY(20px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .error-message {
        display: block;
        font-size: 0.875rem;
        color: #ef4444;
        margin-top: 0.25rem;
      }

      .error-message.hidden {
        display: none;
      }
    </style>

    <section class="py-16 md:py-24">
      <div class="max-w-4xl mx-auto px-4">
        <!-- ヘッダー部分 -->
        <SectionHeading
          title="お問い合わせ"
          level="h1"
          waveLineCount={5}
          titleMarginLeft="ml-4"
        />

        <div class="mb-12">
          <!-- 説明文 -->
          <div class="text-left mb-8">
            <p class="text-lg text-text-gray">ご依頼・ご相談はこちらからお送りください。 </p>
            <p class="text-lg text-text-gray mb-4">内容がまだ決まっていなくても問題ありません。 </p>
            <p class="text-lg text-text-gray">「こんなことはできますか？」 </p>
            <p class="text-lg text-text-gray mb-4">「このイベントに合う内容を相談したい」 </p>
            <p class="text-lg text-text-gray">そんな段階からでも、お気軽にご相談ください。 </p>
          </div>
        </div>
        <!-- Cyan Form Card -->
        <div class="bg-contact-cyan rounded-lg shadow-lg p-4 sm:p-6 md:p-8 mb-12">
          <h2 class="text-2xl font-bold text-white mb-8">お問い合わせフォーム</h2>

          <!-- Custom Contact Form (Web3Forms) -->
          <form id="contact-form" class="space-y-6">
            <!-- Hidden fields -->
            <input type="hidden" name="access_key" value={WEB3FORMS_KEY}>
            <input type="hidden" name="from_name" value="DONATI Contact">
            <input type="hidden" name="subject" value="DONATIウェブサイトからのお問い合わせ">
            <input type="hidden" name="botcheck" value="">

            <!-- Name -->
            <div>
              <label for="name" class="block text-lg font-medium text-white mb-2">
                お名前（担当者名） <span class="bg-[#DC143C] text-white text-xs px-2 py-1 ml-2">必須</span>
              </label>
              <input
                type="text"
                id="name"
                name="name"
                required
                minlength="2"
                maxlength="100"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white text-text-dark focus:outline-none focus:border-primary-color focus:ring-2 focus:ring-primary-color/20 transition-all"
                placeholder="山田 太郎"
              >
              <p class="error-message hidden text-sm mt-1"></p>
            </div>

            <!-- Organization -->
            <div>
              <label for="organization" class="block text-lg font-medium text-white mb-2">
                団体名・貴社名 <span class="bg-[#DC143C] text-white text-xs px-2 py-1 ml-2">必須</span>
              </label>
              <input
                type="text"
                id="organization"
                name="organization"
                required
                minlength="2"
                maxlength="100"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white text-text-dark focus:outline-none focus:border-primary-color focus:ring-2 focus:ring-primary-color/20 transition-all"
                placeholder="株式会社〇〇 / 〇〇小学校"
              >
              <p class="error-message hidden text-sm mt-1"></p>
            </div>

            <!-- Email -->
            <div>
              <label for="email" class="block text-lg font-medium text-white mb-2">
                メールアドレス <span class="bg-[#DC143C] text-white text-xs px-2 py-1 ml-2">必須</span>
              </label>
              <input
                type="email"
                id="email"
                name="email"
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white text-text-dark focus:outline-none focus:border-primary-color focus:ring-2 focus:ring-primary-color/20 transition-all"
                placeholder="example@example.com"
              >
              <p class="text-sm text-white/80 mt-1">返信先のメールアドレスをご入力ください</p>
              <p class="error-message hidden text-sm mt-1"></p>
            </div>

            <!-- Phone (required) -->
            <div>
              <label for="phone" class="block text-lg font-medium text-white mb-2">
                お電話番号 <span class="bg-[#DC143C] text-white text-xs px-2 py-1 ml-2">必須</span>
              </label>
              <input
                type="tel"
                id="phone"
                name="phone"
                required
                pattern="[0-9\-\(\)\s]*"
                minlength="10"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white text-text-dark focus:outline-none focus:border-primary-color focus:ring-2 focus:ring-primary-color/20 transition-all"
                placeholder="090-1234-5678"
              >
              <p class="error-message hidden text-sm mt-1"></p>
            </div>

            <!-- Plan (Select Dropdown) -->
            <div>
              <label for="plan" class="block text-lg font-medium text-white mb-2">
                ご検討中のプラン <span class="text-white/70 text-sm">(任意)</span>
              </label>
              <select
                id="plan"
                name="plan"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white text-text-dark focus:outline-none focus:border-primary-color focus:ring-2 focus:ring-primary-color/20 transition-all"
              >
                <option value="">プランを選択してください（任意）</option>
                <option value="サイエンスパフォーマンスショー">サイエンスパフォーマンスショー</option>
                <option value="わくわく科学実験室！">わくわく科学実験室！</option>
                <option value="ワークショップ">ワークショップ</option>
                <option value="星空・天文イベント">星空・天文イベント</option>
                <option value="まだ決まっていない(相談したい)">まだ決まっていない(相談したい)</option>
              </select>
              <p id="plan-error" class="error-message hidden text-sm mt-1"></p>
            </div>

            <!-- Preferred Date -->
            <div>
              <label for="preferred-date" class="block text-lg font-medium text-white mb-2">
                実施希望時期 <span class="text-white/70 text-sm">(任意)</span>
              </label>
              <input
                type="text"
                id="preferred-date"
                name="preferred_date"
                maxlength="100"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white text-text-dark focus:outline-none focus:border-primary-color focus:ring-2 focus:ring-primary-color/20 transition-all"
                placeholder="例: 2025年3月頃 / 夏休み期間中 / 未定"
              >
              <p class="text-sm text-white/80 mt-1">おおよその時期をご記入ください(未定の場合はその旨をご記入ください)</p>
            </div>

            <!-- Venue -->
            <div>
              <label for="venue" class="block text-lg font-medium text-white mb-2">
                開催予定場所(市町村名・施設名など／わかる範囲で) <span class="text-white/70 text-sm">(任意)</span>
              </label>
              <input
                type="text"
                id="venue"
                name="venue"
                maxlength="200"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white text-text-dark focus:outline-none focus:border-primary-color focus:ring-2 focus:ring-primary-color/20 transition-all"
                placeholder="例: 東京都渋谷区 / 〇〇市民ホール / 未定"
              >
              <p class="text-sm text-white/80 mt-1">おおよその場所をご記入ください(未定の場合はその旨をご記入ください)</p>
            </div>

            <!-- Message -->
            <div>
              <label for="message" class="block text-lg font-medium text-white mb-2">
                お問い合わせ内容・ご要望 <span class="text-white/70 text-sm">(任意)</span>
              </label>
              <textarea
                id="message"
                name="message"
                maxlength="1000"
                rows="6"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white text-text-dark focus:outline-none focus:border-primary-color focus:ring-2 focus:ring-primary-color/20 transition-all resize-vertical"
                placeholder="まだ内容が固まっていない場合でも、ご相談ベースで問題ありません"
              ></textarea>
              <p class="text-sm text-white/80 mt-1">目的や会場条件など、わかる範囲でご記入ください</p>
              <p class="error-message hidden text-sm mt-1"></p>
            </div>

            <!-- Submit Button with SVG -->
            <div class="flex justify-center pt-6">
              <button
                type="submit"
                id="submit-button"
                class="transition-transform hover:scale-105 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                <img
                  src="/images/svg/Parts/contact_confirm_clean.svg"
                  alt="お問い合わせを確定する"
                  class="w-auto h-14 md:h-16"
                />
              </button>
            </div>
          </form>
        </div>

        <!-- FAQ -->
        <!-- TODO: FAQページ作成後に移動予定。デザイン確定まで一時非表示 -->
        <!--
        <div>
          <h2 class="text-2xl font-bold text-text-dark mb-6">よくあるご質問</h2>

          <div class="space-y-4">
            <details class="bg-white rounded-lg shadow p-6">
              <summary class="font-semibold cursor-pointer">出張エリアはどこまで対応可能ですか？</summary>
              <p class="mt-4 text-text-gray">
                関東圏を中心に活動していますが、全国どこでも出張可能です。遠方の場合は交通費・宿泊費等が別途必要となります。
              </p>
            </details>

            <details class="bg-white rounded-lg shadow p-6">
              <summary class="font-semibold cursor-pointer">料金はどのくらいですか？</summary>
              <p class="mt-4 text-text-gray">
                プログラム内容、参加人数、時間などにより異なります。お見積もりは無料ですので、まずはお気軽にご相談ください。
              </p>
            </details>

            <details class="bg-white rounded-lg shadow p-6">
              <summary class="font-semibold cursor-pointer">どのくらい前に予約が必要ですか？</summary>
              <p class="mt-4 text-text-gray">
                ご希望日の1ヶ月前までにご連絡いただけると確実です。直前のご依頼も可能な限り対応いたしますので、ご相談ください。
              </p>
            </details>

            <details class="bg-white rounded-lg shadow p-6">
              <summary class="font-semibold cursor-pointer">雨天時の星空観望会はどうなりますか？</summary>
              <p class="mt-4 text-text-gray">
                室内での星空解説や、天体に関する実験・工作などの代替プログラムをご用意しています。中止の場合はキャンセル料はいただきません。
              </p>
            </details>
          </div>
        </div>
        -->
      </div>
    </section>

    <!-- Success/Error Modal -->
    <div id="message-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50">
      <div id="message-box" class="bg-white rounded-lg shadow-2xl p-8 max-w-md mx-4">
        <!-- 成功時のみ表示されるロゴ（初期状態は非表示） -->
        <div id="success-logo" class="flex justify-center mb-6 hidden">
          <img src="/images/svg/Parts/homeLogo.svg" alt="サイエンス&スペースラボ DONATI" class="h-12 md:h-16" />
        </div>

        <div class="flex items-center mb-4">
          <div id="message-icon" class="mr-3"></div>
          <h3 id="message-title" class="text-xl font-bold"></h3>
        </div>
        <p id="message-text" class="text-text-gray mb-6 leading-relaxed"></p>
        <button
          onclick="window.closeMessageModal()"
          class="w-full btn-primary"
        >
          閉じる
        </button>
      </div>
    </div>

    <FooterDivider />
  </main>

  <Footer />
</Layout>

<script>
  const form = document.getElementById('contact-form') as HTMLFormElement;
  const submitButton = document.getElementById('submit-button') as HTMLButtonElement;
  const messageModal = document.getElementById('message-modal') as HTMLDivElement;

  // Field validation
  const inputs = form.querySelectorAll('input[required], select[required], textarea[required]');

  inputs.forEach(input => {
    input.addEventListener('blur', () => validateField(input as HTMLInputElement | HTMLSelectElement));
    input.addEventListener('input', () => {
      const errorMsg = input.parentElement?.querySelector('.error-message');
      if (errorMsg) {
        errorMsg.classList.add('hidden');
        input.classList.remove('border-red-500');
        input.classList.add('border-gray-300');
      }
    });
  });

  function validateField(field: HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement): boolean {
    const errorMsg = field.parentElement?.querySelector('.error-message') as HTMLElement;

    if (!field.validity.valid) {
      let message = 'こちらの入力をお願いします';

      if (field.validity.valueMissing) {
        message = 'こちらの入力をお願いします';
      } else if (field.validity.typeMismatch && field.type === 'email') {
        message = '有効なメールアドレスをご入力ください';
      } else if (field.validity.tooShort) {
        message = 'もう少し詳しくお聞かせください';
      } else if (field.validity.patternMismatch && field.type === 'tel') {
        message = '有効な電話番号をご入力ください';
      }

      if (errorMsg) {
        errorMsg.textContent = message;
        errorMsg.classList.remove('hidden');
        field.classList.add('border-red-500');
        field.classList.remove('border-gray-300');
      }
      return false;
    }

    if (errorMsg) {
      errorMsg.classList.add('hidden');
      field.classList.remove('border-red-500');
      field.classList.add('border-gray-300');
    }
    return true;
  }

  // Select field validation
  function validateSelectField(): boolean {
    // プランは任意項目のため、常にtrueを返す
    return true;
  }

  // Select change listener for real-time validation
  const planSelect = form.querySelector('select[name="plan"]');
  planSelect?.addEventListener('change', () => {
    const errorMsg = document.getElementById('plan-error');
    if (errorMsg && !errorMsg.classList.contains('hidden')) {
      validateSelectField();
    }
  });

  // Form submission
  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    let isValid = true;
    inputs.forEach(input => {
      if (!validateField(input as HTMLInputElement | HTMLSelectElement)) isValid = false;
    });

    // Validate select field
    if (!validateSelectField()) isValid = false;

    if (!isValid) {
      const firstError = form.querySelector('.border-red-500, #plan-error:not(.hidden)') as HTMLElement;
      firstError?.scrollIntoView({ behavior: 'smooth', block: 'center' });
      return;
    }

    submitButton.disabled = true;

    const formData = new FormData(form);

    try {
      const response = await fetch('https://api.web3forms.com/submit', {
        method: 'POST',
        body: formData
      });

      const result = await response.json();

      console.log('Web3Forms Response:', response.status, result);

      if (result.success) {
        showMessage('success', '送信完了',
          'お問い合わせありがとうございます。\n内容を確認の上、2〜3営業日以内に担当者よりご連絡いたします。\nまだ内容が固まっていない場合でも、ご相談ベースで問題ありません。\n目的や会場条件に合わせて、最適な形をご提案させていただきます。\n\n※数日経っても返信がない場合は、迷惑メールフォルダをご確認の上、\nお手数ですが再度ご連絡ください。');
        form.reset();
      } else {
        console.error('Form submission failed:', result);
        showMessage('error', '送信エラー',
          '送信に失敗しました。もう一度お試しいただくか、お手数ですがメールにてお問い合わせください。');
      }
    } catch (error) {
      console.error('Network error:', error);
      showMessage('error', '送信エラー',
        'ネットワークエラーが発生しました。インターネット接続をご確認の上、もう一度お試しください。');
    } finally {
      submitButton.disabled = false;
    }
  });

  function showMessage(type: 'success' | 'error', title: string, text: string) {
    const messageTitle = document.getElementById('message-title') as HTMLElement;
    const messageText = document.getElementById('message-text') as HTMLElement;
    const messageIcon = document.getElementById('message-icon') as HTMLElement;
    const messageBox = document.getElementById('message-box') as HTMLElement;
    const successLogo = document.getElementById('success-logo') as HTMLElement;

    messageTitle.textContent = title;
    messageText.textContent = text;
    messageText.style.whiteSpace = 'pre-line';

    if (type === 'success') {
      messageIcon.innerHTML = '<svg class="w-8 h-8 text-accent-green" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>';
      messageBox.classList.add('border-l-4', 'border-accent-green');

      // ロゴを表示
      successLogo?.classList.remove('hidden');
    } else {
      messageIcon.innerHTML = '<svg class="w-8 h-8 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>';
      messageBox.classList.add('border-l-4', 'border-red-500');

      // ロゴを非表示
      successLogo?.classList.add('hidden');
    }

    messageModal.classList.remove('hidden');
    messageModal.classList.add('flex');

    setTimeout(() => closeMessageModal(), 5000);
  }

  function closeMessageModal() {
    const messageModal = document.getElementById('message-modal') as HTMLDivElement;
    const messageBox = document.getElementById('message-box') as HTMLElement;
    const successLogo = document.getElementById('success-logo') as HTMLElement;

    messageModal.classList.add('hidden');
    messageModal.classList.remove('flex');
    messageBox.classList.remove('border-l-4', 'border-accent-green', 'border-red-500');

    // ロゴを非表示に戻す
    successLogo?.classList.add('hidden');
  }

  (window as any).closeMessageModal = closeMessageModal;
</script>
