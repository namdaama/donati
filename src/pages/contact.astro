---
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import Hero from '../components/Hero.astro';

// Web3Forms Access Key（ハードコード）
const WEB3FORMS_KEY = 'dfa9ec58-78f2-4ab5-94b5-a109ddb6a5dd';

const contactTypes = [
  '科学実験ショーのご依頼',
  'ワークショップのご依頼',
  '星空観望会のご依頼',
  '探求学習プログラムのご相談',
  'その他のお問い合わせ'
];
---

<Layout title="お問い合わせ">
  <Header />
  
  <main class="flex-grow">
    <style>
      .form-wrapper {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      }

      input, select, textarea {
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
      }

      input:focus, select:focus, textarea:focus {
        outline: none;
        border-color: #2c5aa0;
        box-shadow: 0 0 0 3px rgba(44, 90, 160, 0.1);
      }

      input.border-red-500:focus, select.border-red-500:focus, textarea.border-red-500:focus {
        border-color: #ef4444;
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
      }

      #message-modal {
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }

      #message-box {
        animation: slideUp 0.3s ease;
      }

      @keyframes slideUp {
        from {
          transform: translateY(20px);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      .error-message {
        display: block;
        font-size: 0.875rem;
        color: #ef4444;
        margin-top: 0.25rem;
      }

      .error-message.hidden {
        display: none;
      }
    </style>
    <Hero 
      title="お問い合わせ"
      subtitle="お気軽にご相談ください"
    />
    
    <section class="py-16 md:py-24">
      <div class="container-custom">
        <div class="max-w-4xl mx-auto">
          <div class="text-center mb-12">
            <p class="text-lg text-text-gray">
              科学実験ショー、ワークショップ、星空観望会など、<br />
              各種プログラムのご依頼・ご相談を承っております。<br />
              まずはお気軽にお問い合わせください。
            </p>
          </div>
          
          <!-- Contact Form Info -->
          <div class="bg-white rounded-lg shadow-lg p-8 mb-12">
            <h2 class="text-2xl font-bold text-text-dark mb-6">お問い合わせフォーム</h2>

            <div class="mb-8">
              <h3 class="text-lg font-semibold mb-4">お問い合わせ種別</h3>
              <ul class="space-y-2">
                {contactTypes.map((type) => (
                  <li class="flex items-center">
                    <svg class="w-5 h-5 text-space-blue mr-2" fill="currentColor" viewBox="0 0 20 20">
                      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
                    </svg>
                    <span class="text-text-gray">{type}</span>
                  </li>
                ))}
              </ul>
            </div>

            <div class="bg-gray-50 p-6 rounded-lg">
              <p class="text-center text-text-gray mb-6">
                お問い合わせは以下のフォームからお願いいたします
              </p>

              <!-- Custom Contact Form (Web3Forms) -->
              <div class="form-wrapper bg-white rounded-lg shadow-lg p-6 md:p-8">
                <form id="contact-form" class="space-y-6">
                  <!-- Hidden fields -->
                  <input type="hidden" name="access_key" value={WEB3FORMS_KEY}>
                  <input type="hidden" name="from_name" value="DONATI Contact">
                  <input type="hidden" name="subject" value="DONATIウェブサイトからのお問い合わせ">
                  <input type="hidden" name="botcheck" value="">

                  <!-- Name -->
                  <div>
                    <label for="name" class="block text-lg font-medium text-text-dark mb-2">
                      お名前 <span class="text-red-500">*</span>
                    </label>
                    <input
                      type="text"
                      id="name"
                      name="name"
                      required
                      minlength="2"
                      maxlength="100"
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-primary-color focus:ring-2 focus:ring-primary-color/20 transition-all"
                      placeholder="山田 太郎"
                    >
                    <p class="error-message hidden text-sm text-red-600 mt-1"></p>
                  </div>

                  <!-- Email -->
                  <div>
                    <label for="email" class="block text-lg font-medium text-text-dark mb-2">
                      メールアドレス <span class="text-red-500">*</span>
                    </label>
                    <input
                      type="email"
                      id="email"
                      name="email"
                      required
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-primary-color focus:ring-2 focus:ring-primary-color/20 transition-all"
                      placeholder="example@example.com"
                    >
                    <p class="text-sm text-text-gray mt-1">返信先のメールアドレスをご入力ください</p>
                    <p class="error-message hidden text-sm text-red-600 mt-1"></p>
                  </div>

                  <!-- Phone (optional) -->
                  <div>
                    <label for="phone" class="block text-lg font-medium text-text-dark mb-2">
                      お電話番号 <span class="text-text-gray text-sm">(任意)</span>
                    </label>
                    <input
                      type="tel"
                      id="phone"
                      name="phone"
                      pattern="[0-9\-\(\)\s]*"
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-primary-color focus:ring-2 focus:ring-primary-color/20 transition-all"
                      placeholder="090-1234-5678"
                    >
                    <p class="text-sm text-text-gray mt-1">お急ぎの場合はご記入ください</p>
                    <p class="error-message hidden text-sm text-red-600 mt-1"></p>
                  </div>

                  <!-- Inquiry Type -->
                  <div>
                    <label for="inquiry-type" class="block text-lg font-medium text-text-dark mb-2">
                      お問い合わせ種別 <span class="text-red-500">*</span>
                    </label>
                    <select
                      id="inquiry-type"
                      name="inquiry_type"
                      required
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-primary-color focus:ring-2 focus:ring-primary-color/20 transition-all"
                    >
                      <option value="">選択してください</option>
                      {contactTypes.map((type) => (
                        <option value={type}>{type}</option>
                      ))}
                    </select>
                    <p class="error-message hidden text-sm text-red-600 mt-1"></p>
                  </div>

                  <!-- Message -->
                  <div>
                    <label for="message" class="block text-lg font-medium text-text-dark mb-2">
                      お問い合わせ内容 <span class="text-red-500">*</span>
                    </label>
                    <textarea
                      id="message"
                      name="message"
                      required
                      minlength="10"
                      maxlength="1000"
                      rows="6"
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:border-primary-color focus:ring-2 focus:ring-primary-color/20 transition-all resize-vertical"
                      placeholder="ご質問やご要望を詳しくお聞かせください"
                    ></textarea>
                    <p class="text-sm text-text-gray mt-1">ご質問やご要望を詳しくお聞かせください（10文字以上）</p>
                    <p class="error-message hidden text-sm text-red-600 mt-1"></p>
                  </div>

                  <!-- Submit Button -->
                  <div class="flex justify-center md:justify-start pt-4">
                    <button
                      type="submit"
                      class="btn-primary px-12 py-4 text-lg disabled:opacity-50 disabled:cursor-not-allowed"
                      id="submit-button"
                    >
                      送信する
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          
          <!-- Response Time -->
          <div class="bg-blue-50 border-l-4 border-space-blue p-6 rounded-lg mb-12">
            <h3 class="font-semibold text-text-dark mb-2">ご返信について</h3>
            <p class="text-text-gray">
              お問い合わせいただいた内容は、通常2〜3営業日以内にご返信いたします。<br />
              お急ぎの場合は、その旨をフォームにご記入ください。
            </p>
          </div>
          
          <!-- FAQ -->
          <div>
            <h2 class="text-2xl font-bold text-text-dark mb-6">よくあるご質問</h2>
            
            <div class="space-y-4">
              <details class="bg-white rounded-lg shadow p-6">
                <summary class="font-semibold">出張エリアはどこまで対応可能ですか？</summary>
                <p class="mt-4 text-text-gray">
                  関東圏を中心に活動していますが、全国どこでも出張可能です。遠方の場合は交通費・宿泊費等が別途必要となります。
                </p>
              </details>
              
              <details class="bg-white rounded-lg shadow p-6">
                <summary class="font-semibold">料金はどのくらいですか？</summary>
                <p class="mt-4 text-text-gray">
                  プログラム内容、参加人数、時間などにより異なります。お見積もりは無料ですので、まずはお気軽にご相談ください。
                </p>
              </details>
              
              <details class="bg-white rounded-lg shadow p-6">
                <summary class="font-semibold">どのくらい前に予約が必要ですか？</summary>
                <p class="mt-4 text-text-gray">
                  ご希望日の1ヶ月前までにご連絡いただけると確実です。直前のご依頼も可能な限り対応いたしますので、ご相談ください。
                </p>
              </details>
              
              <details class="bg-white rounded-lg shadow p-6">
                <summary class="font-semibold">雨天時の星空観望会はどうなりますか？</summary>
                <p class="mt-4 text-text-gray">
                  室内での星空解説や、天体に関する実験・工作などの代替プログラムをご用意しています。中止の場合はキャンセル料はいただきません。
                </p>
              </details>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Success/Error Modal -->
    <div id="message-modal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50">
      <div id="message-box" class="bg-white rounded-lg shadow-2xl p-8 max-w-md mx-4">
        <div class="flex items-center mb-4">
          <div id="message-icon" class="mr-3"></div>
          <h3 id="message-title" class="text-xl font-bold"></h3>
        </div>
        <p id="message-text" class="text-text-gray mb-6 leading-relaxed"></p>
        <button
          onclick="window.closeMessageModal()"
          class="w-full btn-primary"
        >
          閉じる
        </button>
      </div>
    </div>
  </main>

  <Footer />
</Layout>

<script>
  const form = document.getElementById('contact-form') as HTMLFormElement;
  const submitButton = document.getElementById('submit-button') as HTMLButtonElement;
  const messageModal = document.getElementById('message-modal') as HTMLDivElement;

  // Field validation
  const inputs = form.querySelectorAll('input[required], select[required], textarea[required]');

  inputs.forEach(input => {
    input.addEventListener('blur', () => validateField(input as HTMLInputElement));
    input.addEventListener('input', () => {
      const errorMsg = input.parentElement?.querySelector('.error-message');
      if (errorMsg) {
        errorMsg.classList.add('hidden');
        input.classList.remove('border-red-500');
        input.classList.add('border-gray-300');
      }
    });
  });

  function validateField(field: HTMLInputElement | HTMLSelectElement | HTMLTextAreaElement): boolean {
    const errorMsg = field.parentElement?.querySelector('.error-message') as HTMLElement;

    if (!field.validity.valid) {
      let message = 'こちらの入力をお願いします';

      if (field.validity.valueMissing) {
        message = 'こちらの入力をお願いします';
      } else if (field.validity.typeMismatch && field.type === 'email') {
        message = '有効なメールアドレスをご入力ください';
      } else if (field.validity.tooShort) {
        message = 'もう少し詳しくお聞かせください';
      } else if (field.validity.patternMismatch && field.type === 'tel') {
        message = '有効な電話番号をご入力ください';
      }

      if (errorMsg) {
        errorMsg.textContent = message;
        errorMsg.classList.remove('hidden');
        field.classList.add('border-red-500');
        field.classList.remove('border-gray-300');
      }
      return false;
    }

    if (errorMsg) {
      errorMsg.classList.add('hidden');
      field.classList.remove('border-red-500');
      field.classList.add('border-gray-300');
    }
    return true;
  }

  // Form submission
  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    let isValid = true;
    inputs.forEach(input => {
      if (!validateField(input as HTMLInputElement)) isValid = false;
    });

    if (!isValid) {
      const firstError = form.querySelector('.border-red-500') as HTMLElement;
      firstError?.focus();
      return;
    }

    submitButton.disabled = true;
    submitButton.textContent = '送信中...';

    const formData = new FormData(form);

    try {
      const response = await fetch('https://api.web3forms.com/submit', {
        method: 'POST',
        body: formData
      });

      const result = await response.json();

      console.log('Web3Forms Response:', response.status, result);

      if (result.success) {
        showMessage('success', '送信完了',
          'お問い合わせありがとうございます。\n通常2〜3営業日以内にご返信いたします。\nお急ぎの場合は、その旨をご記入いただければ優先的に対応させていただきます。');
        form.reset();
      } else {
        console.error('Form submission failed:', result);
        showMessage('error', '送信エラー',
          '送信に失敗しました。もう一度お試しいただくか、お手数ですがメールにてお問い合わせください。');
      }
    } catch (error) {
      console.error('Network error:', error);
      showMessage('error', '送信エラー',
        'ネットワークエラーが発生しました。インターネット接続をご確認の上、もう一度お試しください。');
    } finally {
      submitButton.disabled = false;
      submitButton.textContent = '送信する';
    }
  });

  function showMessage(type: 'success' | 'error', title: string, text: string) {
    const messageTitle = document.getElementById('message-title') as HTMLElement;
    const messageText = document.getElementById('message-text') as HTMLElement;
    const messageIcon = document.getElementById('message-icon') as HTMLElement;
    const messageBox = document.getElementById('message-box') as HTMLElement;

    messageTitle.textContent = title;
    messageText.textContent = text;
    messageText.style.whiteSpace = 'pre-line';

    if (type === 'success') {
      messageIcon.innerHTML = '<svg class="w-8 h-8 text-accent-green" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>';
      messageBox.classList.add('border-l-4', 'border-accent-green');
    } else {
      messageIcon.innerHTML = '<svg class="w-8 h-8 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>';
      messageBox.classList.add('border-l-4', 'border-red-500');
    }

    messageModal.classList.remove('hidden');
    messageModal.classList.add('flex');

    setTimeout(() => closeMessageModal(), 5000);
  }

  function closeMessageModal() {
    const messageModal = document.getElementById('message-modal') as HTMLDivElement;
    const messageBox = document.getElementById('message-box') as HTMLElement;

    messageModal.classList.add('hidden');
    messageModal.classList.remove('flex');
    messageBox.classList.remove('border-l-4', 'border-accent-green', 'border-red-500');
  }

  (window as any).closeMessageModal = closeMessageModal;
</script>